name: Deploy to Production
'on':
  push:
    branches:
      - main
      - master
  workflow_dispatch: null
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Detect changes
        id: changes
        run: |
          echo "ðŸ” DÃ©tection des fichiers modifiÃ©s..."
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "nuxt_changed=true" >> $GITHUB_OUTPUT
            echo "symfony_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement manuel : tout sera dÃ©ployÃ©"
          else
            if [ -n "${{ github.event.before }}" ] && git cat-file -e "${{ github.event.before }}" 2>/dev/null; then
              BEFORE_COMMIT="${{ github.event.before }}"
              AFTER_COMMIT="${{ github.sha }}"
              echo "ðŸ“ Comparaison: $BEFORE_COMMIT..$AFTER_COMMIT"
            elif git rev-parse HEAD~1 >/dev/null 2>&1; then
              BEFORE_COMMIT="HEAD~1"
              AFTER_COMMIT="HEAD"
              echo "ðŸ“ Comparaison avec commit prÃ©cÃ©dent: HEAD~1..HEAD"
            else
              echo "ðŸ“ Fallback: historique limitÃ©, dÃ©ploiement forcÃ©"
              echo "nuxt_changed=true" >> $GITHUB_OUTPUT
              echo "symfony_changed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            if [ -n "$BEFORE_COMMIT" ]; then
              CHANGED_FILES=$(git diff --name-only "$BEFORE_COMMIT" "$AFTER_COMMIT" 2>/dev/null || echo "")
            else
              CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$AFTER_COMMIT" 2>/dev/null || echo "")
            fi
            echo "ðŸ“‹ Fichiers modifiÃ©s:"
            echo "$CHANGED_FILES"
            if echo "$CHANGED_FILES" | grep -qE "^(nuxt/|nuxt\.config\.ts|nuxt\.config\.js|nuxt\.config\.mjs|package\.json|package-lock\.json)"; then
              echo "nuxt_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Changements Nuxt"
            else
              echo "nuxt_changed=false" >> $GITHUB_OUTPUT
            fi
            if echo "$CHANGED_FILES" | grep -qE "^(symfony/|Dockerfile|docker-compose)"; then
              echo "symfony_changed=true" >> $GITHUB_OUTPUT
              echo "âœ… Changements Symfony"
            else
              echo "symfony_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
      - name: Setup Node.js
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: npm
          cache-dependency-path: nuxt/package-lock.json
      - name: Install dependencies
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        working-directory: ./nuxt
        run: npm ci
      - name: Build Nuxt application
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        working-directory: ./nuxt
        env:
          NUXT_PUBLIC_API_BASE: >-
            ${{ secrets.NUXT_PUBLIC_API_BASE ||
            'https://portfolio.vthiebaut.fr/api' }}
          NUXT_PUBLIC_EMAILJS_SERVICE_ID: '${{ secrets.NUXT_PUBLIC_EMAILJS_SERVICE_ID }}'
          NUXT_PUBLIC_EMAILJS_TEMPLATE_ID: '${{ secrets.NUXT_PUBLIC_EMAILJS_TEMPLATE_ID }}'
          NUXT_PUBLIC_EMAILJS_PUBLIC_KEY: '${{ secrets.NUXT_PUBLIC_EMAILJS_PUBLIC_KEY }}'
          NUXT_PUBLIC_SITE_URL: 'https://portfolio.vthiebaut.fr'
        run: "echo \"\U0001F528 Build de l'application Nuxt...\"\nnpm run generate\n\n# VÃ©rifier que le build a rÃ©ussi\nif [ ! -d \".output/public\" ]; then\n  echo \"âŒ Erreur: Le build n'a pas gÃ©nÃ©rÃ© .output/public\"\n  exit 1\nfi\n\necho \"âœ… Build terminÃ©\"\necho \"\U0001F4C1 Contenu de .output/public:\"\nls -la .output/public | head -20\n"
      - name: Create deployment archive
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        run: "# VÃ©rifier que les fichiers existent\nif [ ! -d \"nuxt/.output/public\" ]; then\n  echo \"âŒ Erreur: nuxt/.output/public n'existe pas\"\n  ls -la nuxt/.output/ || echo \"Le dossier .output n'existe pas\"\n  exit 1\nfi\n\n# VÃ©rifier qu'il y a des fichiers\nif [ -z \"$(ls -A nuxt/.output/public)\" ]; then\n  echo \"âŒ Erreur: nuxt/.output/public est vide\"\n  exit 1\nfi\n\n# VÃ©rifier que le sitemap existe et afficher son contenu\nif [ -f \"nuxt/.output/public/sitemap.xml\" ]; then\n  echo \"âœ… Sitemap trouvÃ© dans le build\"\n  echo \"\U0001F4C4 Contenu du sitemap (premiÃ¨res lignes):\"\n  head -20 nuxt/.output/public/sitemap.xml\n  echo \"\U0001F4C5 Date du fichier: $(stat -c %y nuxt/.output/public/sitemap.xml 2>/dev/null || ls -l nuxt/.output/public/sitemap.xml)\"\nelse\n  echo \"âš ï¸ Avertissement: sitemap.xml non trouvÃ© dans .output/public\"\n  echo \"\U0001F4C1 Fichiers prÃ©sents:\"\n  ls -la nuxt/.output/public/ | head -20\nfi\n\necho \"\U0001F4E6 CrÃ©ation de l'archive...\"\n# CrÃ©er l'archive depuis le rÃ©pertoire de travail racine\ncd nuxt/.output/public\ntar -czf ${{ github.workspace }}/deploy-nuxt.tar.gz .\ncd ${{ github.workspace }}\n\n# VÃ©rifier que l'archive a Ã©tÃ© crÃ©Ã©e et n'est pas vide\nif [ ! -f \"deploy-nuxt.tar.gz\" ] || [ ! -s \"deploy-nuxt.tar.gz\" ]; then\n  echo \"âŒ Erreur: L'archive n'a pas Ã©tÃ© crÃ©Ã©e ou est vide\"\n  ls -la | grep tar || echo \"Aucun fichier tar trouvÃ©\"\n  exit 1\nfi\n\necho \"âœ… Archive crÃ©Ã©e: $(du -h deploy-nuxt.tar.gz | cut -f1)\"\nls -lh deploy-nuxt.tar.gz\n\n# VÃ©rifier que le sitemap est dans l'archive\nif tar -tzf deploy-nuxt.tar.gz | grep -q \"sitemap.xml\"; then\n  echo \"âœ… sitemap.xml trouvÃ© dans l'archive\"\nelse\n  echo \"âš ï¸ Avertissement: sitemap.xml non trouvÃ© dans l'archive\"\n  echo \"\U0001F4C1 Fichiers dans l'archive:\"\n  tar -tzf deploy-nuxt.tar.gz | head -20\nfi\n"
      - name: Verify archive before deploy
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        run: |
          if [ ! -f "deploy-nuxt.tar.gz" ]; then
            echo "âŒ Erreur: deploy-nuxt.tar.gz n'existe pas"
            ls -la | grep tar || echo "Aucun fichier tar trouvÃ©"
            exit 1
          fi

          if [ ! -s "deploy-nuxt.tar.gz" ]; then
            echo "âŒ Erreur: deploy-nuxt.tar.gz est vide"
            exit 1
          fi

          echo "âœ… Archive vÃ©rifiÃ©e: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          ls -lh deploy-nuxt.tar.gz
      - name: Prepare deployment directory
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' ||
          steps.changes.outputs.symfony_changed == 'true' || github.event_name
          == 'workflow_dispatch'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: '${{ secrets.SERVER_HOST }}'
          username: '${{ secrets.SERVER_USER }}'
          key: '${{ secrets.SERVER_SSH_KEY }}'
          port: '${{ secrets.SERVER_PORT || 22 }}'
          script: "# Nettoyer l'ancien fichier/dossier deploy-nuxt.tar.gz s'il existe\nif [ -d \"/tmp/deploy-nuxt.tar.gz\" ]; then\n  echo \"\U0001F9F9 Suppression de l'ancien dossier /tmp/deploy-nuxt.tar.gz\"\n  rm -rf /tmp/deploy-nuxt.tar.gz\nfi\nif [ -f \"/tmp/deploy-nuxt.tar.gz\" ]; then\n  echo \"\U0001F9F9 Suppression de l'ancien fichier /tmp/deploy-nuxt.tar.gz\"\n  rm -f /tmp/deploy-nuxt.tar.gz\nfi\n\n# PrÃ©parer le rÃ©pertoire de dÃ©ploiement\nsudo mkdir -p /var/www/portfolio\n\n# Sauvegarder uniquement les fichiers Nuxt (pas les config Docker)\nif [ \"${{ steps.changes.outputs.nuxt_changed }}\" == \"true\" ] || [ \"${{ github.event_name }}\" == \"workflow_dispatch\" ]; then\n  echo \"\U0001F4BE Sauvegarde des anciens fichiers Nuxt...\"\n  BACKUP_DIR=\"/var/www/portfolio.backup.$(date +%Y%m%d_%H%M%S)\"\n  sudo mkdir -p \"$BACKUP_DIR\"\n  \n  # Sauvegarder uniquement les fichiers Nuxt (exclure config Docker et symfony)\n  if [ -d \"/var/www/portfolio\" ]; then\n    sudo find /var/www/portfolio -maxdepth 1 -type f ! -name \"docker-compose.prod.yml\" ! -name \"Caddyfile\" ! -name \"Dockerfile\" -exec cp {} \"$BACKUP_DIR/\" \\; 2>/dev/null || true\n    sudo find /var/www/portfolio -maxdepth 1 -type d ! -name \"symfony\" ! -name \".\" ! -name \"..\" -exec cp -r {} \"$BACKUP_DIR/\" \\; 2>/dev/null || true\n  fi\n  \n  echo \"âœ… Sauvegarde crÃ©Ã©e dans $BACKUP_DIR\"\nfi\n"
      - name: Transfer archive via rsync
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' || github.event_name ==
          'workflow_dispatch'
        run: "echo \"\U0001F4E4 Transfert de l'archive via rsync...\"\n\n# VÃ©rifier que l'archive existe localement\nif [ ! -f \"deploy-nuxt.tar.gz\" ]; then\n  echo \"âŒ Erreur: deploy-nuxt.tar.gz n'existe pas localement\"\n  ls -la | grep tar || echo \"Aucun fichier tar trouvÃ©\"\n  exit 1\nfi\n\necho \"\U0001F4E6 Taille de l'archive: $(du -h deploy-nuxt.tar.gz | cut -f1)\"\n\n# CrÃ©er la clÃ© SSH\necho \"${{ secrets.SERVER_SSH_KEY }}\" > /tmp/deploy_key\nchmod 600 /tmp/deploy_key\n\n# Test de connexion SSH\necho \"\U0001F50D Test de connexion SSH...\"\nssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \"echo 'âœ… Connexion SSH OK'\" || {\n  echo \"âŒ Erreur: Impossible de se connecter au serveur\"\n  rm -f /tmp/deploy_key\n  exit 1\n}\n\n# TransfÃ©rer le fichier (rsync avec --no-dirs pour Ã©viter de crÃ©er un dossier)\necho \"\U0001F4E4 Transfert en cours...\"\nrsync -avz --progress --no-dirs -e \"ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }}\" deploy-nuxt.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-nuxt.tar.gz || {\n  echo \"âŒ Erreur: Ã‰chec du transfert rsync\"\n  rm -f /tmp/deploy_key\n  exit 1\n}\n\n# VÃ©rifier que c'est bien un fichier et non un dossier\necho \"\U0001F50D VÃ©rification du fichier sur le serveur...\"\nssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \"test -f /tmp/deploy-nuxt.tar.gz && echo 'âœ… Fichier transfÃ©rÃ© correctement' && ls -lh /tmp/deploy-nuxt.tar.gz || (echo 'âŒ Erreur: ce n est pas un fichier' && ls -la /tmp/ | grep tar && exit 1)\" || {\n  echo \"âŒ Erreur: VÃ©rification du fichier Ã©chouÃ©e\"\n  rm -f /tmp/deploy_key\n  exit 1\n}\n\nrm -f /tmp/deploy_key\necho \"âœ… Archive transfÃ©rÃ©e et vÃ©rifiÃ©e\"\n"
      - name: Deploy and restart services
        if: >-
          steps.changes.outputs.nuxt_changed == 'true' ||
          steps.changes.outputs.symfony_changed == 'true' || github.event_name
          == 'workflow_dispatch'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: '${{ secrets.SERVER_HOST }}'
          username: '${{ secrets.SERVER_USER }}'
          key: '${{ secrets.SERVER_SSH_KEY }}'
          port: '${{ secrets.SERVER_PORT || 22 }}'
          script: "# === DÃ‰PLOIEMENT NUXT (si nÃ©cessaire) ===\n# DÃ©ployer si changements dÃ©tectÃ©s, workflow manuel, ou si le dossier ne contient que les fichiers de config\nSHOULD_DEPLOY_NUXT=false\nif [ \"${{ steps.changes.outputs.nuxt_changed }}\" == \"true\" ] || [ \"${{ github.event_name }}\" == \"workflow_dispatch\" ]; then\n  SHOULD_DEPLOY_NUXT=true\nelse\n  # VÃ©rifier si le dossier ne contient que les fichiers de config (pas de fichiers Nuxt)\n  FILES_COUNT=$(ls -A /var/www/portfolio 2>/dev/null | grep -v docker-compose.prod.yml | grep -v Caddyfile | grep -v Dockerfile | grep -v symfony | wc -l)\n  if [ \"$FILES_COUNT\" -eq 0 ]; then\n    SHOULD_DEPLOY_NUXT=true\n    echo \"\U0001F4C1 Dossier vide ou ne contient que les config, dÃ©ploiement nÃ©cessaire\"\n  fi\nfi\n\nif [ \"$SHOULD_DEPLOY_NUXT\" == \"true\" ]; then\n  echo \"\U0001F4E6 DÃ©ploiement du frontend Nuxt...\"\n  \n  # VÃ©rifier que l'archive existe\n  if [ ! -f \"/tmp/deploy-nuxt.tar.gz\" ]; then\n    echo \"âŒ Erreur: /tmp/deploy-nuxt.tar.gz n'existe pas\"\n    ls -la /tmp/ | grep tar || echo \"Aucun fichier tar dans /tmp/\"\n    exit 1\n  fi\n  \n  # VÃ©rifier les permissions de l'archive\n  ls -lh /tmp/deploy-nuxt.tar.gz\n  \n  # Sauvegarder la date actuelle du sitemap (si existe)\n  if [ -f \"/var/www/portfolio/sitemap.xml\" ]; then\n    echo \"\U0001F4C5 Ancien sitemap: $(stat -c %y /var/www/portfolio/sitemap.xml)\"\n  fi\n  \n  # Supprimer uniquement les anciens fichiers Nuxt (prÃ©server config Docker et symfony)\n  echo \"\U0001F9F9 Nettoyage des anciens fichiers Nuxt...\"\n  # Supprimer les fichiers (pas les dossiers)\n  sudo find /var/www/portfolio -maxdepth 1 -type f ! -name \"docker-compose.prod.yml\" ! -name \"Caddyfile\" ! -name \"Dockerfile\" -delete 2>/dev/null || true\n  # Supprimer les dossiers Nuxt (pas symfony)\n  sudo find /var/www/portfolio -maxdepth 1 -type d ! -name \"symfony\" ! -name \".\" ! -name \"..\" ! -name \"portfolio\" -exec rm -rf {} + 2>/dev/null || true\n  \n  # VÃ©rifier que les fichiers de config sont toujours lÃ \n  echo \"\U0001F4CB Fichiers de config prÃ©servÃ©s:\"\n  ls -la /var/www/portfolio/ | grep -E \"docker-compose|Caddyfile|Dockerfile|symfony\" || echo \"âš ï¸ Aucun fichier de config trouvÃ©\"\n  \n  # Extraire le nouveau build avec les bonnes permissions\n  echo \"\U0001F4E6 Extraction de l'archive...\"\n  sudo tar -xzf /tmp/deploy-nuxt.tar.gz -C /var/www/portfolio\n  \n  # VÃ©rifier que les fichiers ont Ã©tÃ© extraits\n  if [ -z \"$(ls -A /var/www/portfolio)\" ]; then\n    echo \"âŒ Erreur: /var/www/portfolio est vide aprÃ¨s extraction\"\n    exit 1\n  fi\n  \n  echo \"âœ… Fichiers extraits: $(ls /var/www/portfolio | wc -l) fichiers\"\n  \n  # VÃ©rifier que le sitemap a Ã©tÃ© mis Ã  jour\n  if [ -f \"/var/www/portfolio/sitemap.xml\" ]; then\n    echo \"\U0001F4C5 Nouveau sitemap: $(stat -c %y /var/www/portfolio/sitemap.xml)\"\n    echo \"\U0001F4C4 Contenu du sitemap (premiÃ¨res lignes):\"\n    head -20 /var/www/portfolio/sitemap.xml\n  else\n    echo \"âš ï¸ Avertissement: sitemap.xml non trouvÃ© aprÃ¨s extraction\"\n  fi\n  \n  # Permissions\n  sudo chown -R www-data:www-data /var/www/portfolio 2>/dev/null || sudo chown -R 1000:1000 /var/www/portfolio || true\n  sudo chmod -R 755 /var/www/portfolio || true\n  rm -f /tmp/deploy-nuxt.tar.gz\nelse\n  echo \"â„¹ï¸ Pas de changement dans Nuxt et dossier contient dÃ©jÃ  les fichiers, skip du dÃ©ploiement frontend\"\nfi\n\n# === DÃ‰PLOIEMENT SYMFONY (si nÃ©cessaire) ===\nif [ \"${{ steps.changes.outputs.symfony_changed }}\" == \"true\" ]; then\n  echo \"\U0001F527 DÃ©ploiement de l'API Symfony...\"\n  cd /var/www/portfolio || exit 1\n  \n  # VÃ©rifier que c'est un dÃ©pÃ´t Git, sinon skip le pull\n  if [ -d \".git\" ]; then\n    echo \"\U0001F4E5 Pull des derniÃ¨res modifications...\"\n    git pull origin main || git pull origin master || true\n  else\n    echo \"âš ï¸ /var/www/portfolio n'est pas un dÃ©pÃ´t Git, skip du pull\"\n  fi\n  \n  # Rebuild et redÃ©marre les containers\n  echo \"\U0001F528 Rebuild des containers Docker...\"\n  docker compose -f docker-compose.prod.yml down\n  docker compose -f docker-compose.prod.yml build --no-cache\n  docker compose -f docker-compose.prod.yml up -d\n  \n  # Attendre que les services soient prÃªts\n  echo \"â³ Attente du dÃ©marrage des services...\"\n  sleep 15\n  \n  # ExÃ©cuter les migrations\n  echo \"\U0001F504 ExÃ©cution des migrations...\"\n  docker exec php php bin/console doctrine:migrations:migrate --no-interaction || true\nelse\n  echo \"â„¹ï¸ Pas de changement dans Symfony, skip du dÃ©ploiement backend\"\nfi\n\n# === REDÃ‰MARRAGE CADDY (si Nuxt a changÃ©) ===\nif [ \"${{ steps.changes.outputs.nuxt_changed }}\" == \"true\" ] || [ \"${{ github.event_name }}\" == \"workflow_dispatch\" ]; then\n  echo \"\U0001F504 RedÃ©marrage de Caddy pour charger les nouveaux fichiers...\"\n  docker compose -f docker-compose.prod.yml restart caddy || docker compose -f docker-compose.prod.yml up -d caddy || true\nfi\n\necho \"âœ… DÃ©ploiement terminÃ© avec succÃ¨s !\"\necho \"\U0001F4C1 Frontend: /var/www/portfolio\"\necho \"\U0001F433 Containers: $(docker ps --format '{{.Names}}' | grep -E 'php|caddy|db' | wc -l) services actifs\"\n"
      - name: Cleanup
        if: >-
          always() && (steps.changes.outputs.nuxt_changed == 'true' ||
          github.event_name == 'workflow_dispatch')
        run: rm -f deploy-nuxt.tar.gz
