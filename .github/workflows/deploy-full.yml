name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # === D√âTECTION DES CHANGEMENTS ===
      - name: Detect changes
        id: changes
        run: |
          echo "üîç D√©tection des fichiers modifi√©s..."
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "nuxt_changed=true" >> $GITHUB_OUTPUT
            echo "symfony_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ D√©ploiement manuel : tout sera d√©ploy√©"
          else
            # D√©terminer la m√©thode de comparaison
            # V√©rifier si github.event.before existe et est valide
            if [ -n "${{ github.event.before }}" ] && git cat-file -e "${{ github.event.before }}" 2>/dev/null; then
              BEFORE_COMMIT="${{ github.event.before }}"
              AFTER_COMMIT="${{ github.sha }}"
              echo "üìù Comparaison: $BEFORE_COMMIT..$AFTER_COMMIT"
            elif git rev-parse HEAD~1 >/dev/null 2>&1; then
              # Fallback: comparer avec le commit pr√©c√©dent
              BEFORE_COMMIT="HEAD~1"
              AFTER_COMMIT="HEAD"
              echo "üìù Comparaison avec commit pr√©c√©dent: HEAD~1..HEAD"
          else
            # Dernier fallback: historique limit√© (shallow clone, premier commit, etc.)
            # Dans ce cas, on ne prend pas de risque: on consid√®re qu'il y a des changements.
            BEFORE_COMMIT=""
            AFTER_COMMIT="${{ github.sha }}"
            echo "üìù Analyse du commit actuel uniquement (fallback historique limit√©)"
            echo "nuxt_changed=true" >> $GITHUB_OUTPUT
            echo "symfony_changed=true" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Historique Git incomplet, d√©ploiement forc√© du frontend et du backend"
            exit 0
          fi
          
          # D√©tecter les changements dans Nuxt (inclure nuxt.config.ts, package.json, etc.)
          if [ -n "$BEFORE_COMMIT" ]; then
            CHANGED_FILES=$(git diff --name-only "$BEFORE_COMMIT" "$AFTER_COMMIT" 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$AFTER_COMMIT" 2>/dev/null || echo "")
          fi
          
          echo "üìã Fichiers modifi√©s pour comparaison:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -qE "^(nuxt/|nuxt\.config\.ts|nuxt\.config\.js|nuxt\.config\.mjs|package\.json|package-lock\.json)"; then
            echo "nuxt_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changements d√©tect√©s dans Nuxt"
          else
            echo "nuxt_changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Aucun changement dans Nuxt"
          fi
          
          # D√©tecter les changements dans Symfony
          if echo "$CHANGED_FILES" | grep -qE "^(symfony/|Dockerfile|docker-compose)"; then
            echo "symfony_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changements d√©tect√©s dans Symfony"
          else
            echo "symfony_changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Aucun changement dans Symfony"
          fi
        fi

      # === BUILD NUXT (si n√©cessaire) ===
      - name: Setup Node.js
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: nuxt/package-lock.json

      - name: Install dependencies
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        working-directory: ./nuxt
        run: npm ci

      - name: Build Nuxt application
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        working-directory: ./nuxt
        env:
          NUXT_PUBLIC_API_BASE: ${{ secrets.NUXT_PUBLIC_API_BASE || 'https://portfolio.vthiebaut.fr/api' }}
          NUXT_PUBLIC_EMAILJS_SERVICE_ID: ${{ secrets.NUXT_PUBLIC_EMAILJS_SERVICE_ID }}
          NUXT_PUBLIC_EMAILJS_TEMPLATE_ID: ${{ secrets.NUXT_PUBLIC_EMAILJS_TEMPLATE_ID }}
          NUXT_PUBLIC_EMAILJS_PUBLIC_KEY: ${{ secrets.NUXT_PUBLIC_EMAILJS_PUBLIC_KEY }}
          # Forcer l'URL de base pour le sitemap
          NUXT_PUBLIC_SITE_URL: 'https://portfolio.vthiebaut.fr'
        run: |
          echo "üî® Build de l'application Nuxt..."
          npm run generate
          
          # V√©rifier que le build a r√©ussi
          if [ ! -d ".output/public" ]; then
            echo "‚ùå Erreur: Le build n'a pas g√©n√©r√© .output/public"
            exit 1
          fi
          
          echo "‚úÖ Build termin√©"
          echo "üìÅ Contenu de .output/public:"
          ls -la .output/public | head -20

      - name: Create deployment archive
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # V√©rifier que les fichiers existent
          if [ ! -d "nuxt/.output/public" ]; then
            echo "‚ùå Erreur: nuxt/.output/public n'existe pas"
            ls -la nuxt/.output/ || echo "Le dossier .output n'existe pas"
            exit 1
          fi
          
          # V√©rifier qu'il y a des fichiers
          if [ -z "$(ls -A nuxt/.output/public)" ]; then
            echo "‚ùå Erreur: nuxt/.output/public est vide"
            exit 1
          fi
          
          # V√©rifier que le sitemap existe et afficher son contenu
          if [ -f "nuxt/.output/public/sitemap.xml" ]; then
            echo "‚úÖ Sitemap trouv√© dans le build"
            echo "üìÑ Contenu du sitemap (premi√®res lignes):"
            head -20 nuxt/.output/public/sitemap.xml
            echo "üìÖ Date du fichier: $(stat -c %y nuxt/.output/public/sitemap.xml 2>/dev/null || ls -l nuxt/.output/public/sitemap.xml)"
          else
            echo "‚ö†Ô∏è Avertissement: sitemap.xml non trouv√© dans .output/public"
            echo "üìÅ Fichiers pr√©sents:"
            ls -la nuxt/.output/public/ | head -20
          fi
          
          echo "üì¶ Cr√©ation de l'archive..."
          # Cr√©er l'archive depuis le r√©pertoire de travail racine
          cd nuxt/.output/public
          tar -czf ${{ github.workspace }}/deploy-nuxt.tar.gz .
          cd ${{ github.workspace }}
          
          # V√©rifier que l'archive a √©t√© cr√©√©e et n'est pas vide
          if [ ! -f "deploy-nuxt.tar.gz" ] || [ ! -s "deploy-nuxt.tar.gz" ]; then
            echo "‚ùå Erreur: L'archive n'a pas √©t√© cr√©√©e ou est vide"
            ls -la | grep tar || echo "Aucun fichier tar trouv√©"
            exit 1
          fi
          
          echo "‚úÖ Archive cr√©√©e: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          ls -lh deploy-nuxt.tar.gz
          
          # V√©rifier que le sitemap est dans l'archive
          if tar -tzf deploy-nuxt.tar.gz | grep -q "sitemap.xml"; then
            echo "‚úÖ sitemap.xml trouv√© dans l'archive"
          else
            echo "‚ö†Ô∏è Avertissement: sitemap.xml non trouv√© dans l'archive"
            echo "üìÅ Fichiers dans l'archive:"
            tar -tzf deploy-nuxt.tar.gz | head -20
          fi

      # === V√âRIFICATION ARCHIVE ===
      - name: Verify archive before deploy
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          if [ ! -f "deploy-nuxt.tar.gz" ]; then
            echo "‚ùå Erreur: deploy-nuxt.tar.gz n'existe pas"
            ls -la | grep tar || echo "Aucun fichier tar trouv√©"
            exit 1
          fi
          
          if [ ! -s "deploy-nuxt.tar.gz" ]; then
            echo "‚ùå Erreur: deploy-nuxt.tar.gz est vide"
            exit 1
          fi
          
          echo "‚úÖ Archive v√©rifi√©e: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          ls -lh deploy-nuxt.tar.gz

      # === PR√âPARATION SERVEUR ===
      - name: Prepare deployment directory
        if: steps.changes.outputs.nuxt_changed == 'true' || steps.changes.outputs.symfony_changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # Nettoyer l'ancien fichier/dossier deploy-nuxt.tar.gz s'il existe
            if [ -d "/tmp/deploy-nuxt.tar.gz" ]; then
              echo "üßπ Suppression de l'ancien dossier /tmp/deploy-nuxt.tar.gz"
              rm -rf /tmp/deploy-nuxt.tar.gz
            fi
            if [ -f "/tmp/deploy-nuxt.tar.gz" ]; then
              echo "üßπ Suppression de l'ancien fichier /tmp/deploy-nuxt.tar.gz"
              rm -f /tmp/deploy-nuxt.tar.gz
            fi
            
            # Pr√©parer le r√©pertoire de d√©ploiement
            sudo mkdir -p /var/www/portfolio
            
            # Sauvegarder uniquement les fichiers Nuxt (pas les config Docker)
            if [ "${{ steps.changes.outputs.nuxt_changed }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "üíæ Sauvegarde des anciens fichiers Nuxt..."
              BACKUP_DIR="/var/www/portfolio.backup.$(date +%Y%m%d_%H%M%S)"
              sudo mkdir -p "$BACKUP_DIR"
              
              # Sauvegarder uniquement les fichiers Nuxt (exclure config Docker et symfony)
              if [ -d "/var/www/portfolio" ]; then
                sudo find /var/www/portfolio -maxdepth 1 -type f ! -name "docker-compose.prod.yml" ! -name "Caddyfile" ! -name "Dockerfile" -exec cp {} "$BACKUP_DIR/" \; 2>/dev/null || true
                sudo find /var/www/portfolio -maxdepth 1 -type d ! -name "symfony" ! -name "." ! -name ".." -exec cp -r {} "$BACKUP_DIR/" \; 2>/dev/null || true
              fi
              
              echo "‚úÖ Sauvegarde cr√©√©e dans $BACKUP_DIR"
            fi

      # === TRANSFERT ARCHIVE NUXT ===
      - name: Transfer archive via rsync
        if: steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üì§ Transfert de l'archive via rsync..."
          
          # V√©rifier que l'archive existe localement
          if [ ! -f "deploy-nuxt.tar.gz" ]; then
            echo "‚ùå Erreur: deploy-nuxt.tar.gz n'existe pas localement"
            ls -la | grep tar || echo "Aucun fichier tar trouv√©"
            exit 1
          fi
          
          echo "üì¶ Taille de l'archive: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          
          # Cr√©er la cl√© SSH
          echo "${{ secrets.SERVER_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          # Test de connexion SSH
          echo "üîç Test de connexion SSH..."
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo '‚úÖ Connexion SSH OK'" || {
            echo "‚ùå Erreur: Impossible de se connecter au serveur"
            rm -f /tmp/deploy_key
            exit 1
          }
          
          # Transf√©rer le fichier (rsync avec --no-dirs pour √©viter de cr√©er un dossier)
          echo "üì§ Transfert en cours..."
          rsync -avz --progress --no-dirs -e "ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }}" deploy-nuxt.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-nuxt.tar.gz || {
            echo "‚ùå Erreur: √âchec du transfert rsync"
            rm -f /tmp/deploy_key
            exit 1
          }
          
          # V√©rifier que c'est bien un fichier et non un dossier
          echo "üîç V√©rification du fichier sur le serveur..."
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "test -f /tmp/deploy-nuxt.tar.gz && echo '‚úÖ Fichier transf√©r√© correctement' && ls -lh /tmp/deploy-nuxt.tar.gz || (echo '‚ùå Erreur: ce n est pas un fichier' && ls -la /tmp/ | grep tar && exit 1)" || {
            echo "‚ùå Erreur: V√©rification du fichier √©chou√©e"
            rm -f /tmp/deploy_key
            exit 1
          }
          
          rm -f /tmp/deploy_key
          echo "‚úÖ Archive transf√©r√©e et v√©rifi√©e"

      # === D√âPLOIEMENT ===
      - name: Deploy and restart services
        if: steps.changes.outputs.nuxt_changed == 'true' || steps.changes.outputs.symfony_changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # === D√âPLOIEMENT NUXT (si n√©cessaire) ===
            # D√©ployer si changements d√©tect√©s, workflow manuel, ou si le dossier ne contient que les fichiers de config
            SHOULD_DEPLOY_NUXT=false
            if [ "${{ steps.changes.outputs.nuxt_changed }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              SHOULD_DEPLOY_NUXT=true
            else
              # V√©rifier si le dossier ne contient que les fichiers de config (pas de fichiers Nuxt)
              FILES_COUNT=$(ls -A /var/www/portfolio 2>/dev/null | grep -v docker-compose.prod.yml | grep -v Caddyfile | grep -v Dockerfile | grep -v symfony | wc -l)
              if [ "$FILES_COUNT" -eq 0 ]; then
                SHOULD_DEPLOY_NUXT=true
                echo "üìÅ Dossier vide ou ne contient que les config, d√©ploiement n√©cessaire"
              fi
            fi
            
            if [ "$SHOULD_DEPLOY_NUXT" == "true" ]; then
              echo "üì¶ D√©ploiement du frontend Nuxt..."
              
              # V√©rifier que l'archive existe
              if [ ! -f "/tmp/deploy-nuxt.tar.gz" ]; then
                echo "‚ùå Erreur: /tmp/deploy-nuxt.tar.gz n'existe pas"
                ls -la /tmp/ | grep tar || echo "Aucun fichier tar dans /tmp/"
                exit 1
              fi
              
              # V√©rifier les permissions de l'archive
              ls -lh /tmp/deploy-nuxt.tar.gz
              
              # Sauvegarder la date actuelle du sitemap (si existe)
              if [ -f "/var/www/portfolio/sitemap.xml" ]; then
                echo "üìÖ Ancien sitemap: $(stat -c %y /var/www/portfolio/sitemap.xml)"
              fi
              
              # Supprimer uniquement les anciens fichiers Nuxt (pr√©server config Docker et symfony)
              echo "üßπ Nettoyage des anciens fichiers Nuxt..."
              # Supprimer les fichiers (pas les dossiers)
              sudo find /var/www/portfolio -maxdepth 1 -type f ! -name "docker-compose.prod.yml" ! -name "Caddyfile" ! -name "Dockerfile" -delete 2>/dev/null || true
              # Supprimer les dossiers Nuxt (pas symfony)
              sudo find /var/www/portfolio -maxdepth 1 -type d ! -name "symfony" ! -name "." ! -name ".." ! -name "portfolio" -exec rm -rf {} + 2>/dev/null || true
              
              # V√©rifier que les fichiers de config sont toujours l√†
              echo "üìã Fichiers de config pr√©serv√©s:"
              ls -la /var/www/portfolio/ | grep -E "docker-compose|Caddyfile|Dockerfile|symfony" || echo "‚ö†Ô∏è Aucun fichier de config trouv√©"
              
              # Extraire le nouveau build avec les bonnes permissions
              echo "üì¶ Extraction de l'archive..."
              sudo tar -xzf /tmp/deploy-nuxt.tar.gz -C /var/www/portfolio
              
              # V√©rifier que les fichiers ont √©t√© extraits
              if [ -z "$(ls -A /var/www/portfolio)" ]; then
                echo "‚ùå Erreur: /var/www/portfolio est vide apr√®s extraction"
                exit 1
              fi
              
              echo "‚úÖ Fichiers extraits: $(ls /var/www/portfolio | wc -l) fichiers"
              
              # V√©rifier que le sitemap a √©t√© mis √† jour
              if [ -f "/var/www/portfolio/sitemap.xml" ]; then
                echo "üìÖ Nouveau sitemap: $(stat -c %y /var/www/portfolio/sitemap.xml)"
                echo "üìÑ Contenu du sitemap (premi√®res lignes):"
                head -20 /var/www/portfolio/sitemap.xml
              else
                echo "‚ö†Ô∏è Avertissement: sitemap.xml non trouv√© apr√®s extraction"
              fi
              
              # Permissions
              sudo chown -R www-data:www-data /var/www/portfolio 2>/dev/null || sudo chown -R 1000:1000 /var/www/portfolio || true
              sudo chmod -R 755 /var/www/portfolio || true
              rm -f /tmp/deploy-nuxt.tar.gz
            else
              echo "‚ÑπÔ∏è Pas de changement dans Nuxt et dossier contient d√©j√† les fichiers, skip du d√©ploiement frontend"
            fi
            
            # === D√âPLOIEMENT SYMFONY (si n√©cessaire) ===
            if [ "${{ steps.changes.outputs.symfony_changed }}" == "true" ]; then
              echo "üîß D√©ploiement de l'API Symfony..."
              cd /var/www/portfolio || exit 1
              
              # V√©rifier que c'est un d√©p√¥t Git, sinon skip le pull
              if [ -d ".git" ]; then
                echo "üì• Pull des derni√®res modifications..."
                git pull origin main || git pull origin master || true
              else
                echo "‚ö†Ô∏è /var/www/portfolio n'est pas un d√©p√¥t Git, skip du pull"
              fi
              
              # Rebuild et red√©marre les containers
              echo "üî® Rebuild des containers Docker..."
              docker compose -f docker-compose.prod.yml down
              docker compose -f docker-compose.prod.yml build --no-cache
              docker compose -f docker-compose.prod.yml up -d
              
              # Attendre que les services soient pr√™ts
              echo "‚è≥ Attente du d√©marrage des services..."
              sleep 15
              
              # Ex√©cuter les migrations
              echo "üîÑ Ex√©cution des migrations..."
              docker exec php php bin/console doctrine:migrations:migrate --no-interaction || true
            else
              echo "‚ÑπÔ∏è Pas de changement dans Symfony, skip du d√©ploiement backend"
            fi
            
            # === RED√âMARRAGE CADDY (si Nuxt a chang√©) ===
            if [ "${{ steps.changes.outputs.nuxt_changed }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "üîÑ Red√©marrage de Caddy pour charger les nouveaux fichiers..."
              docker compose -f docker-compose.prod.yml restart caddy || docker compose -f docker-compose.prod.yml up -d caddy || true
            fi
            
            echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
            echo "üìÅ Frontend: /var/www/portfolio"
            echo "üê≥ Containers: $(docker ps --format '{{.Names}}' | grep -E 'php|caddy|db' | wc -l) services actifs"
            
      # === NETTOYAGE ===
      - name: Cleanup
        if: always() && (steps.changes.outputs.nuxt_changed == 'true' || github.event_name == 'workflow_dispatch')
        run: rm -f deploy-nuxt.tar.gz

