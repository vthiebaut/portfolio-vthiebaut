name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: nuxt/package-lock.json

      - name: Install dependencies
        working-directory: ./nuxt
        run: npm ci

      - name: Build Nuxt application
        working-directory: ./nuxt
        env:
          NUXT_PUBLIC_API_BASE: ${{ secrets.NUXT_PUBLIC_API_BASE || 'https://portfolio.vthiebaut.fr/api' }}
          NUXT_PUBLIC_EMAILJS_SERVICE_ID: ${{ secrets.NUXT_PUBLIC_EMAILJS_SERVICE_ID }}
          NUXT_PUBLIC_EMAILJS_TEMPLATE_ID: ${{ secrets.NUXT_PUBLIC_EMAILJS_TEMPLATE_ID }}
          NUXT_PUBLIC_EMAILJS_PUBLIC_KEY: ${{ secrets.NUXT_PUBLIC_EMAILJS_PUBLIC_KEY }}
        run: |
          echo "ğŸ”¨ Build de l'application Nuxt..."
          npm run generate
          
          # VÃ©rifier que le build a rÃ©ussi
          if [ ! -d ".output/public" ]; then
            echo "âŒ Erreur: Le build n'a pas gÃ©nÃ©rÃ© .output/public"
            exit 1
          fi
          
          echo "âœ… Build terminÃ©"
          echo "ğŸ“ Contenu de .output/public:"
          ls -la .output/public | head -20

      - name: Create deployment archive
        run: |
          # VÃ©rifier que les fichiers existent
          if [ ! -d "nuxt/.output/public" ]; then
            echo "âŒ Erreur: nuxt/.output/public n'existe pas"
            ls -la nuxt/.output/ || echo "Le dossier .output n'existe pas"
            exit 1
          fi
          
          # VÃ©rifier qu'il y a des fichiers
          if [ -z "$(ls -A nuxt/.output/public)" ]; then
            echo "âŒ Erreur: nuxt/.output/public est vide"
            exit 1
          fi
          
          echo "ğŸ“¦ CrÃ©ation de l'archive..."
          # CrÃ©er l'archive depuis le rÃ©pertoire de travail racine
          cd nuxt/.output/public
          tar -czf ${{ github.workspace }}/deploy-nuxt.tar.gz .
          cd ${{ github.workspace }}
          
          # VÃ©rifier que l'archive a Ã©tÃ© crÃ©Ã©e et n'est pas vide
          if [ ! -f "deploy-nuxt.tar.gz" ] || [ ! -s "deploy-nuxt.tar.gz" ]; then
            echo "âŒ Erreur: L'archive n'a pas Ã©tÃ© crÃ©Ã©e ou est vide"
            ls -la | grep tar || echo "Aucun fichier tar trouvÃ©"
            exit 1
          fi
          
          echo "âœ… Archive crÃ©Ã©e: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          ls -lh deploy-nuxt.tar.gz
          pwd

      - name: Verify archive before deploy
        run: |
          if [ ! -f "deploy-nuxt.tar.gz" ]; then
            echo "âŒ Erreur: deploy-nuxt.tar.gz n'existe pas"
            ls -la | grep tar || echo "Aucun fichier tar trouvÃ©"
            exit 1
          fi
          
          if [ ! -s "deploy-nuxt.tar.gz" ]; then
            echo "âŒ Erreur: deploy-nuxt.tar.gz est vide"
            exit 1
          fi
          
          echo "âœ… Archive vÃ©rifiÃ©e: $(du -h deploy-nuxt.tar.gz | cut -f1)"
          ls -lh deploy-nuxt.tar.gz

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # Nettoyer l'ancien fichier/dossier deploy-nuxt.tar.gz s'il existe
            if [ -d "/tmp/deploy-nuxt.tar.gz" ]; then
              echo "ğŸ§¹ Suppression de l'ancien dossier /tmp/deploy-nuxt.tar.gz"
              rm -rf /tmp/deploy-nuxt.tar.gz
            fi
            if [ -f "/tmp/deploy-nuxt.tar.gz" ]; then
              echo "ğŸ§¹ Suppression de l'ancien fichier /tmp/deploy-nuxt.tar.gz"
              rm -f /tmp/deploy-nuxt.tar.gz
            fi
            
            # PrÃ©parer le rÃ©pertoire de dÃ©ploiement
            sudo mkdir -p /var/www/portfolio
            
            # Sauvegarder l'ancien build (optionnel, pour rollback)
            if [ -d "/var/www/portfolio" ] && [ "$(ls -A /var/www/portfolio 2>/dev/null)" ]; then
              sudo mv /var/www/portfolio /var/www/portfolio.backup.$(date +%Y%m%d_%H%M%S) || true
            fi
            
            sudo mkdir -p /var/www/portfolio

      - name: Transfer archive via rsync
        run: |
          echo "ğŸ“¤ Transfert de l'archive via rsync..."
          echo "${{ secrets.SERVER_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          # TransfÃ©rer le fichier (rsync avec --no-dirs pour Ã©viter de crÃ©er un dossier)
          rsync -avz --progress --no-dirs -e "ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }}" deploy-nuxt.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/deploy-nuxt.tar.gz
          
          # VÃ©rifier que c'est bien un fichier et non un dossier
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "test -f /tmp/deploy-nuxt.tar.gz && echo 'âœ… Fichier transfÃ©rÃ© correctement' || (echo 'âŒ Erreur: ce n est pas un fichier' && ls -ld /tmp/deploy-nuxt.tar.gz && exit 1)"
          
          rm -f /tmp/deploy_key
          echo "âœ… Archive transfÃ©rÃ©e et vÃ©rifiÃ©e"

      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # VÃ©rifier que l'archive existe
            if [ ! -f "/tmp/deploy-nuxt.tar.gz" ]; then
              echo "âŒ Erreur: /tmp/deploy-nuxt.tar.gz n'existe pas"
              ls -la /tmp/ | grep tar || echo "Aucun fichier tar dans /tmp/"
              exit 1
            fi
            
            # VÃ©rifier les permissions de l'archive
            ls -lh /tmp/deploy-nuxt.tar.gz
            
            # Extraire le nouveau build avec les bonnes permissions
            echo "ğŸ“¦ Extraction de l'archive..."
            sudo tar -xzf /tmp/deploy-nuxt.tar.gz -C /var/www/portfolio
            
            # VÃ©rifier que les fichiers ont Ã©tÃ© extraits
            if [ -z "$(ls -A /var/www/portfolio)" ]; then
              echo "âŒ Erreur: /var/www/portfolio est vide aprÃ¨s extraction"
              exit 1
            fi
            
            echo "âœ… Fichiers extraits: $(ls /var/www/portfolio | wc -l) fichiers"
            
            # DÃ©finir les bonnes permissions
            sudo chown -R www-data:www-data /var/www/portfolio || sudo chown -R 1000:1000 /var/www/portfolio || true
            sudo chmod -R 755 /var/www/portfolio || true
            
            # Nettoyer l'archive
            rm -f /tmp/deploy-nuxt.tar.gz
            echo "ğŸ§¹ Archive nettoyÃ©e"
            
            # DÃ©marrer/redÃ©marrage des containers Docker
            echo "ğŸ”„ DÃ©marrage/redÃ©marrage des containers Docker..."
            if command -v docker &> /dev/null; then
              cd /var/www/portfolio 2>/dev/null || {
                echo "âŒ Impossible d'accÃ©der Ã  /var/www/portfolio"
                exit 1
              }
              
              if [ ! -f "docker-compose.prod.yml" ]; then
                echo "âš ï¸ docker-compose.prod.yml non trouvÃ© dans /var/www/portfolio"
                echo "ğŸ“ Fichiers prÃ©sents :"
                ls -la | head -10
                echo "âš ï¸ DÃ©marrage manuel nÃ©cessaire"
                exit 0
              fi
              
              echo "ğŸ“‹ Fichier docker-compose.prod.yml trouvÃ©"
              
              # DÃ©marrer les containers s'ils ne sont pas dÃ©jÃ  lancÃ©s
              echo "ğŸš€ DÃ©marrage des containers..."
              docker compose -f docker-compose.prod.yml up -d
              
              # Attendre un peu que les containers dÃ©marrent
              sleep 5
              
              # VÃ©rifier que les containers tournent
              echo "ğŸ” VÃ©rification de l'Ã©tat des containers..."
              docker compose -f docker-compose.prod.yml ps
              
              # RedÃ©marrer Caddy pour charger les nouveaux fichiers
              echo "ğŸ”„ RedÃ©marrage de Caddy..."
              docker compose -f docker-compose.prod.yml restart caddy || docker compose -f docker-compose.prod.yml up -d caddy
              
              echo "âœ… Containers Docker dÃ©marrÃ©s/redÃ©marrÃ©s"
            else
              echo "âš ï¸ Docker non trouvÃ©, dÃ©marrage manuel nÃ©cessaire"
            fi
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
            echo "ğŸ“ Fichiers dÃ©ployÃ©s dans /var/www/portfolio"

      - name: Cleanup
        if: always()
        run: rm -f deploy-nuxt.tar.gz

